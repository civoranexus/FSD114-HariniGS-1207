{% load static %}
<!doctype html>
<html>
<head>
  <title>{{ lesson.title }}</title>
  <link rel="stylesheet" href="{% static 'courses/lessons.css' %}">
</head>

<body>
<div class="lesson-layout">

  <!-- ðŸ“š SIDEBAR -->
  <aside class="lesson-sidebar">
    <h3>{{ course.title }}</h3>
    <ul>
      {% for l in lessons %}
      <li class="
        {% if l.id == lesson.id %}active{% endif %}
        {% if l.id in completed_lessons %}completed{% endif %}
        {% if l.id not in unlocked_lessons %}locked{% endif %}
      ">
        {% if l.id in unlocked_lessons %}
          <a href="{% url 'courses:lesson_detail' course.id l.id %}">
            {{ l.title }}
          </a>
        {% else %}
          ðŸ”’ {{ l.title }}
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  </aside>

  <!-- ðŸ“– MAIN CONTENT -->
  <main class="lesson-content">
    <h2>{{ lesson.title }}</h2>

    <!-- ðŸŽ¥ VIDEO -->
    {% if lesson.video %}
    <video id="lessonVideo" controls width="100%">
      <source src="{{ lesson.video.url }}" type="video/mp4">
    </video>
    {% endif %}

    <!-- ðŸ“„ TEXT -->
    {% if lesson.content %}
    <div class="lesson-text">
      {{ lesson.content|linebreaks }}
    </div>
    {% endif %}

    <!-- âœ… MARK AS COMPLETE -->
   {% if not progress.completed %}
<form method="POST" action="{% url 'courses:mark_lesson_completed' lesson.id %}">
    {% csrf_token %}
    <button class="complete-btn">
        Mark as Complete
    </button>
</form>
{% else %}
<p class="completed-text">âœ… Lesson Completed</p>
{% endif %}

    <!-- â¬…âž¡ NAVIGATION -->
   <div class="lesson-nav">

    {% if prev_lesson %}
    <a href="{% url 'courses:lesson_detail' course.id prev_lesson.id %}">
        â¬… Previous
    </a>
    {% endif %}

    {% if next_lesson %}
        {% if progress.completed %}
        <a href="{% url 'courses:lesson_detail' course.id next_lesson.id %}">
            Next âž¡
        </a>
        {% else %}
        <span class="disabled">ðŸ”’ Complete this lesson to unlock next</span>
        {% endif %}
    {% else %}
        <span class="disabled">ðŸŽ‰ Last Lesson</span>
    {% endif %}

</div>


  </main>
</div>
<input type="hidden" id="isLastLesson" value="{% if not next_lesson %}true{% else %}false{% endif %}">
<script>
  const video = document.getElementById("lessonVideo");
  const btn = document.getElementById("completeBtn");
  const isLastLesson =
    document.getElementById("isLastLesson")?.value === "true";

  if (video && btn) {
    video.addEventListener("ended", () => {
      // Enable button ONLY for last lesson video
      if (isLastLesson) {
        btn.disabled = false;
        btn.style.background = "#22c55e";
      }
    });
  }
</script>

</body>
</html>
